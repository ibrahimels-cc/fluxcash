<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flux Cash - User</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #00ff88;
            --primary-glow: rgba(0, 255, 136, 0.4);
            --secondary: #7000ff;
            --bg-dark: #050505;
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass: blur(15px);
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --danger: #ff3333;
            --font: 'Tajawal', sans-serif;
            --gradient: linear-gradient(135deg, var(--secondary), var(--primary));
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: var(--font); background: var(--bg-dark); color: var(--text-main); overflow-x: hidden; min-height: 100vh; padding-bottom: 80px; }

        .hidden { display: none !important; }
        .glass-card { background: var(--card-bg); backdrop-filter: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; box-shadow: 0 4px 30px rgba(0,0,0,0.2); margin-bottom: 15px; position: relative; overflow: hidden; transition: 0.3s; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.3s; font-family: var(--font); color: white; }
        .btn-primary { background: var(--gradient); box-shadow: 0 5px 20px var(--primary-glow); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .input-box { width: 100%; padding: 15px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: var(--font); margin-bottom: 10px; }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* App Specifics */
        .avatar-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; background: #000; }
        .balance-usd { font-size: 3rem; font-weight: 900; letter-spacing: -1px; }
        .points-tag { background: rgba(0,0,0,0.4); padding: 6px 15px; border-radius: 20px; font-size: 0.9rem; color: var(--primary); display: inline-flex; align-items: center; gap: 5px; margin-top: 5px; }
        
        .earn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .earn-card { text-align: center; padding: 20px; transition: 0.3s; cursor: pointer; }
        .earn-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
        .task-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 15px; border-radius: 15px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); }
        .task-btn { background: var(--secondary); color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; }

        /* FIXED GAME OVERLAY & HEADER */
        #game-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; }
        #game-header { 
            padding: 10px 20px; 
            background: rgba(10,10,10,0.95); 
            border-bottom: 1px solid var(--primary); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 70px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        #game-info { display: flex; flex-direction: column; }
        #game-timer { color: var(--primary); font-weight: bold; font-size: 1.2rem; font-family: monospace; }
        #game-reward-display { font-size: 0.8rem; color: #fff; }
        #game-frame { flex: 1; border: none; width: 100%; background: #fff; }

        /* Wheel Overlay */
        #wheel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .wheel-container { width: 300px; height: 300px; border-radius: 50%; border: 5px solid var(--primary); position: relative; overflow: hidden; background: #111; transition: 5s cubic-bezier(0.25, 0.1, 0.25, 1); }
        .wheel-section { position: absolute; width: 50%; height: 50%; transform-origin: 100% 100%; left: 0; top: 0; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; box-sizing: border-box; }
        .wheel-pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid var(--danger); z-index: 10; }

        /* Chat */
        .msg { padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; max-width: 80%; width: fit-content; font-size: 0.9rem; }
        .msg-me { align-self: flex-end; background: var(--gradient); color: white; margin-right: 0; margin-left: auto; }
        .msg-admin { align-self: flex-start; background: #333; color: white; margin-left: 0; margin-right: auto; }

        /* Popups */
        #flash-popup { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 20000; display: flex; justify-content: center; align-items: center; }
        .broadcast-msg { position: fixed; left: 20px; right: 20px; background: rgba(20,20,20,0.95); border: 1px solid var(--primary); padding: 15px; border-radius: 10px; z-index: 9000; text-align: center; color: white; animation: popIn 0.5s; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .bc-top { top: 20px; } .bc-bottom { bottom: 90px; } .bc-center { top: 50%; transform: translateY(-50%); }
        @keyframes popIn { from{transform:translateY(-20px);opacity:0} to{transform:translateY(0);opacity:1} }

        /* Level */
        .level-container { margin-top: 20px; text-align: right; }
        .level-bar-bg { width: 100%; height: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .level-bar-fill { height: 100%; background: var(--gradient); width: 0%; transition: 1s; }
        .level-badge { background: var(--secondary); padding: 2px 10px; border-radius: 10px; font-size: 0.7rem; color: white; }

        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 15px 0; z-index: 1000; }
        .nav-item { color: var(--text-muted); font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }

        /* Toast */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #111; border: 1px solid var(--primary); padding: 10px 20px; border-radius: 30px; z-index: 10000; transition: 0.3s; display: flex; align-items: center; gap: 10px; opacity: 0; }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>

    <div id="toast"><i class="ri-checkbox-circle-fill" style="color:var(--primary)"></i> <span id="toast-msg">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­</span></div>

    <!-- Maintenance -->
    <div id="maint-screen" class="hidden" style="position:fixed;inset:0;background:#000;z-index:99999;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;">
        <i class="ri-tools-fill" style="font-size:5rem;color:var(--primary);margin-bottom:20px;"></i>
        <h2 style="color:white;">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
    </div>

    <!-- Ban -->
    <div id="ban-screen" class="hidden" style="position:fixed;inset:0;background:#000;z-index:99999;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;">
        <i class="ri-prohibited-line" style="font-size:5rem;color:var(--danger);margin-bottom:20px;"></i>
        <h2 style="color:var(--danger);">ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ</h2>
    </div>

    <!-- Flash Popup -->
    <div id="flash-popup" class="hidden" onclick="this.classList.add('hidden')">
        <div style="position:relative; width:90%; max-width:350px;">
            <button style="position:absolute;top:-15px;right:-15px;background:red;color:white;border:none;border-radius:50%;width:30px;height:30px;">X</button>
            <img id="flash-img-src" src="" style="width:100%; border-radius:15px; border:2px solid var(--primary);">
        </div>
    </div>

    <!-- Auth -->
    <div id="auth" style="padding:30px; min-height:100vh; display:flex; flex-direction:column; justify-content:center;">
        <div class="glass-card fade-in">
            <h2 style="text-align:center; margin-bottom:20px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <input type="text" id="reg-name" class="input-box hidden" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="email" id="email" class="input-box" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="pass" class="input-box" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="handleAuth()" class="btn btn-primary" id="auth-btn">Ø¯Ø®ÙˆÙ„</button>
            <p onclick="toggleAuth()" style="text-align:center; margin-top:15px; color:#aaa; cursor:pointer;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</p>
        </div>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
        
        <!-- HOME -->
        <section id="home-page" class="fade-in">
            <div class="app-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img id="u-avatar-small" class="avatar-img" src="">
                    <div>
                        <div style="font-size:0.8rem; color:#aaa;">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="ver-badge"></span></div>
                        <div style="font-weight:bold;" id="u-name">User</div>
                    </div>
                </div>
            </div>

            <div id="private-notifs" style="padding:0 20px;"></div>
            <div id="broadcast-area"></div>

            <div class="glass-card" style="margin:0 20px; text-align:center;">
                <div style="font-size:0.8rem; color:#aaa;">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ</div>
                <div class="balance-usd">$<span id="u-usd">0.00</span></div>
                <div class="points-tag"><i class="ri-coin-fill"></i> <span id="u-pts">0</span></div>
                <div style="font-size:0.7rem; color:#aaa; margin-top:5px;">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù: <span id="rate-disp">1000</span> Ù†Ù‚Ø·Ø© = $1</div>
                
                <div style="margin-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button onclick="convert()" class="btn btn-outline" style="padding:8px; font-size:0.8rem;">ØªØ­ÙˆÙŠÙ„</button>
                    <button onclick="nav('withdraw')" class="btn btn-primary" style="padding:8px; font-size:0.8rem;">Ø³Ø­Ø¨</button>
                </div>
            </div>

            <div id="leaderboard-sec" class="hidden glass-card" style="margin:0 20px 15px;">
                <h4 style="margin-bottom:10px; color:var(--primary);"><i class="ri-trophy-fill"></i> Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h4>
                <div id="leader-list" style="font-size:0.9rem;"></div>
            </div>

            <div class="earn-grid">
                <div class="glass-card earn-card" onclick="openTasks('game')"><i class="ri-gamepad-fill earn-icon" style="color:#ff0055;"></i><h4>Ø£Ù„Ø¹Ø§Ø¨</h4></div>
                <div class="glass-card earn-card" onclick="openTasks('task')"><i class="ri-todo-fill earn-icon" style="color:#0088ff;"></i><h4>Ù…Ù‡Ø§Ù…</h4></div>
                <div class="glass-card earn-card" onclick="openWheel()"><i class="ri-pie-chart-2-fill earn-icon" style="color:#ffaa00;"></i><h4>Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸</h4></div>
                <div class="glass-card earn-card" onclick="dailyBonus()"><i class="ri-gift-2-fill earn-icon" style="color:#00ff88;"></i><h4>ÙŠÙˆÙ…ÙŠ</h4></div>
            </div>
        </section>

        <!-- LIST -->
        <section id="tasks-page" class="hidden fade-in" style="padding:20px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                <button onclick="nav('home')" style="background:none; border:none; color:white; font-size:1.5rem;"><i class="ri-arrow-right-line"></i></button>
                <h2>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h2>
            </div>
            <div id="tasks-list"></div>
        </section>

        <!-- WITHDRAW -->
        <section id="withdraw-page" class="hidden fade-in" style="padding:20px;">
            <h2 style="margin-bottom:20px;">Ø§Ù„Ø³Ø­Ø¨</h2>
            <div class="glass-card">
                <select id="w-method" class="input-box" style="background:#222;"><option>loading...</option></select>
                <input type="number" id="w-amount" class="input-box" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <input type="text" id="w-addr" class="input-box" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                <button onclick="withdraw()" class="btn btn-primary">Ø³Ø­Ø¨</button>
            </div>
            <div id="w-history"></div>
        </section>

        <!-- SUPPORT -->
        <section id="support-page" class="hidden fade-in" style="padding:20px;">
            <h2 style="margin-bottom:20px;">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h2>
            <div id="chat-box" class="glass-card" style="height:60vh; overflow-y:auto; display:flex; flex-direction:column; gap:10px;"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="chat-input" class="input-box" style="margin:0;" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
                <button onclick="sendMsg()" class="btn btn-primary" style="width:auto;"><i class="ri-send-plane-fill"></i></button>
            </div>
        </section>

        <!-- PROFILE -->
        <section id="profile-page" class="hidden fade-in" style="padding:20px; text-align:center;">
            <img id="p-avatar" class="avatar-img" style="width:100px; height:100px; margin:0 auto 15px;" src="">
            <h2 id="p-name-2">User</h2>
            <div style="margin:5px auto; display:inline-block; background:rgba(255,255,255,0.1); padding:5px 15px; border-radius:20px; font-size:0.8rem;"><span id="p-country">ğŸŒ Global</span></div>
            <div class="glass-card level-container">
                <div style="display:flex; justify-content:space-between;"><span id="lvl-name" class="level-badge">Ù…Ø¨ØªØ¯Ø¦</span><small id="lvl-next">...</small></div>
                <div class="level-bar-bg"><div id="lvl-bar" class="level-bar-fill"></div></div>
            </div>
            <p id="p-email-2" style="color:#aaa; margin-top:10px; margin-bottom:20px;">...</p>
            <div class="glass-card" style="border:1px dashed var(--primary); margin-top:10px;">
                <div style="font-size:0.8rem; color:#aaa;">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©</div>
                <span id="ref-code" style="font-size:1.2rem; font-weight:bold; color:var(--primary); letter-spacing:2px;">LOADING</span>
            </div>
            <button onclick="auth.signOut()" class="btn btn-outline" style="border-color:var(--danger); color:var(--danger); margin-top:20px;">Ø®Ø±ÙˆØ¬</button>
        </section>

    </div>

    <!-- GAME OVERLAY (With Info & Auto Close) -->
    <div id="game-overlay" class="hidden">
        <div id="game-header">
            <div id="game-info">
                <span id="game-timer">00:00</span>
                <span id="game-reward-display">...</span>
            </div>
            <button onclick="closeGame()" style="background:var(--danger); border:none; color:white; padding:5px 15px; border-radius:8px; font-weight:bold;">Ø®Ø±ÙˆØ¬</button>
        </div>
        <!-- Using Iframe for everything to ensure timer stays on top -->
        <iframe id="game-frame" style="width:100%; flex:1; border:none; background:#fff;"></iframe>
    </div>

    <!-- WHEEL -->
    <div id="wheel-overlay" class="hidden">
        <h2 style="color:white; margin-bottom:20px;">Ø¬Ø±Ø¨ Ø­Ø¸Ùƒ!</h2>
        <div style="position:relative;"><div class="wheel-pointer"></div><div class="wheel-container" id="wheel"><div style="position:absolute; top:0; left:0; width:100%; height:100%; background:conic-gradient(#ff0055 0deg 90deg, #0088ff 90deg 180deg, #ffaa00 180deg 270deg, #00ff88 270deg 360deg);"></div></div></div>
        <button onclick="spinWheel()" class="btn btn-primary" style="width:200px; margin-top:30px;" id="spin-btn">Ø¯ÙˆØ±Ø§Ù†</button>
        <button onclick="document.getElementById('wheel-overlay').classList.add('hidden')" style="background:none; border:none; color:#aaa; margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <nav class="bottom-nav hidden" id="navbar">
        <div class="nav-item active" onclick="nav('home')"><i class="ri-home-5-line"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-item" onclick="nav('withdraw')"><i class="ri-wallet-3-line"></i><span>Ø³Ø­Ø¨</span></div>
        <div class="nav-item" onclick="nav('support')"><i class="ri-customer-service-2-line"></i><span>Ø§Ù„Ø¯Ø¹Ù…</span></div>
        <div class="nav-item" onclick="nav('profile')"><i class="ri-user-3-line"></i><span>Ø­Ø³Ø§Ø¨ÙŠ</span></div>
    </nav>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDYcs_MasNecH2TgY1hPnYVb5Npp2mVSeE", authDomain: "fluxcash-2261d.firebaseapp.com", databaseURL: "https://fluxcash-2261d-default-rtdb.firebaseio.com", projectId: "fluxcash-2261d", storageBucket: "fluxcash-2261d.firebasestorage.app", messagingSenderId: "1019180136606", appId: "1:1019180136606:web:d6a8909dc84050aed7e38f", measurementId: "G-80Y3FGZT1Y" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null, userData = {}, settings = {}, activeTask = null, timerInt = null;

        auth.onAuthStateChanged(u => {
            if(u) {
                currentUser = u;
                document.getElementById('auth').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('navbar').classList.remove('hidden');
                initApp();
            } else document.getElementById('auth').classList.remove('hidden');
        });

        function toggleAuth() { document.getElementById('reg-name').classList.toggle('hidden'); }
        function handleAuth() {
            let e = document.getElementById('email').value, p = document.getElementById('pass').value, n = document.getElementById('reg-name').value;
            if(!document.getElementById('reg-name').classList.contains('hidden')) {
                auth.createUserWithEmailAndPassword(e, p).then(c => {
                    db.ref('users/'+c.user.uid).set({username:n, email:e, points:0, balance:0, refCode: Math.random().toString(36).substring(2,8).toUpperCase(), joined:Date.now()});
                }).catch(alert);
            } else auth.signInWithEmailAndPassword(e, p).catch(alert);
        }

        function initApp() {
            db.ref('settings').on('value', s => {
                settings = s.val() || {};
                document.getElementById('maint-screen').classList.toggle('hidden', !settings.maintenance);
                document.getElementById('rate-disp').innerText = settings.exchangeRate || 1000;
                document.getElementById('leaderboard-sec').classList.toggle('hidden', !settings.leaderboard);
                if(settings.leaderboard) loadLeaderboard();
                if(settings.flashEvent?.active && !sessionStorage.getItem('flashSeen')) {
                    document.getElementById('flash-img-src').src = settings.flashEvent.image;
                    document.getElementById('flash-popup').classList.remove('hidden');
                    sessionStorage.setItem('flashSeen', 'true');
                }
            });

            db.ref('users/'+currentUser.uid).on('value', s => {
                userData = s.val();
                if(userData.isBanned) { document.getElementById('ban-screen').classList.remove('hidden'); return; }
                
                document.getElementById('u-name').innerText = userData.username;
                let verHtml = userData.isVerified ? ' <i class="ri-checkbox-circle-fill" style="color:#1da1f2;"></i>' : '';
                document.getElementById('p-name-2').innerHTML = userData.username + verHtml;
                document.getElementById('p-email-2').textContent = userData.email;
                document.getElementById('u-usd').textContent = userData.balance.toFixed(2);
                document.getElementById('u-pts').textContent = userData.points;
                document.getElementById('ref-code').innerText = userData.refCode;
                let av = userData.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${userData.username}`;
                document.getElementById('u-avatar-small').src = av;
                document.getElementById('p-avatar').src = av;
                if(userData.isVerified) document.getElementById('ver-badge').innerHTML = '<i class="ri-checkbox-circle-fill" style="color:#1da1f2"></i>';
                updateLevel(userData.points);
            });

            db.ref('withdrawals').orderByChild('userId').equalTo(currentUser.uid).on('value', s => {
                let h=''; s.forEach(c => {
                    let w=c.val(), st=w.status;
                    let col = st==='approved'?'var(--primary)':(st==='rejected'?'red':'orange');
                    h+=`<div class="glass-card" style="padding:10px; font-size:0.8rem;"><div style="display:flex;justify-content:space-between;"><span>${w.method}</span><b>$${w.amount}</b></div><div style="color:${col}">${st}</div></div>`;
                });
                document.getElementById('w-history').innerHTML = h;
            });

            db.ref('payment_methods').on('value', s => {
                let h=''; s.forEach(c => h+=`<option value="${c.val().name}">${c.val().name}</option>`);
                document.getElementById('w-method').innerHTML = h;
            });

            db.ref('system_alerts').limitToLast(1).on('child_added', s => {
                let a = s.val();
                if(Date.now()-a.timestamp < 10000) showToast(a.message);
            });

            loadChat();
        }

        // --- FIXED GAME LOGIC ---
        function openTasks(cat) {
            nav('tasks');
            const list = document.getElementById('tasks-list');
            list.innerHTML = '<p style="text-align:center; color:#aaa;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>';
            db.ref('tasks').orderByChild('category').equalTo(cat).once('value', s => {
                list.innerHTML = '';
                if(s.numChildren() === 0) { list.innerHTML = '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</p>'; return; }
                s.forEach(c => {
                    let t=c.val();
                    list.innerHTML += `<div class="task-item"><div><b>${t.title}</b><br><small>${t.time}s</small></div><button onclick="startGame('${c.key}','${t.type}','${t.content}',${t.time},${t.points})" class="task-btn">+${t.points}</button></div>`;
                });
            });
        }

        function startGame(id, type, content, time, points) {
            activeTask = { pts: points };
            document.getElementById('game-overlay').classList.remove('hidden');
            
            // Show Reward Amount in Header
            document.getElementById('game-reward-display').innerText = `Ø³ØªØ±Ø¨Ø­: ${points} Ù†Ù‚Ø·Ø©`;

            const frame = document.getElementById('game-frame');
            if(type === 'html') {
                frame.contentWindow.document.open();
                frame.contentWindow.document.write(content);
                frame.contentWindow.document.close();
            } else {
                // IMPORTANT: For links to show timer, we use iframe. 
                // Note: Some sites block iframes.
                frame.src = content; 
            }

            let t = time;
            document.getElementById('game-timer').innerText = formatTime(t);
            
            if(timerInt) clearInterval(timerInt);
            timerInt = setInterval(() => {
                t--;
                document.getElementById('game-timer').innerText = formatTime(t);
                if(t <= 0) {
                    clearInterval(timerInt);
                    // AUTO CLAIM
                    let finalPts = settings.happyHour ? points * 2 : points;
                    db.ref('users/'+currentUser.uid).update({points: (userData.points||0) + finalPts});
                    closeGame();
                    showToast(`Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ø¨Ø­Øª ${finalPts} Ù†Ù‚Ø·Ø©`);
                }
            }, 1000);
        }

        function closeGame() {
            document.getElementById('game-overlay').classList.add('hidden');
            document.getElementById('game-frame').src = 'about:blank';
            clearInterval(timerInt);
        }

        function formatTime(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }

        function dailyBonus() {
            let now = Date.now();
            let last = userData.lastDaily || 0;
            let cooldown = (settings.dailyCooldown || 24) * 3600000;
            if(now - last < cooldown) return showToast("Ø¹Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹");
            let pts = settings.dailyBonus || 50;
            db.ref('users/'+currentUser.uid).update({points: userData.points+pts, lastDaily: now});
            showToast(`+${pts} Ù†Ù‚Ø·Ø©`);
        }

        function spinWheel() {
            let limit = settings.wheelLimit || 3;
            let today = new Date().toDateString();
            if(userData.lastWheelDate !== today) userData.spinsToday = 0;
            if((userData.spinsToday||0) >= limit) return showToast("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª");

            const btn = document.getElementById('spin-btn'); btn.disabled = true;
            document.getElementById('wheel').style.transform = `rotate(${Math.floor(1000 + Math.random() * 3000)}deg)`;
            setTimeout(() => {
                let prizes = (settings.wheelPrizes || "10,20,50,0,100").split(',').map(Number);
                let win = prizes[Math.floor(Math.random() * prizes.length)];
                db.ref('users/'+currentUser.uid).update({
                    points: userData.points + win,
                    spinsToday: (userData.spinsToday||0) + 1,
                    lastWheelDate: today
                });
                showToast(`Ø±Ø¨Ø­Øª ${win} Ù†Ù‚Ø·Ø©`);
                btn.disabled = false;
                document.getElementById('wheel-overlay').classList.add('hidden');
            }, 4000);
        }
        function openWheel() { document.getElementById('wheel-overlay').classList.remove('hidden'); }

        let tid=null;
        function loadChat() {
            db.ref('support_tickets').orderByChild('userId').equalTo(currentUser.uid).on('value', s => {
                let b = document.getElementById('chat-box'); b.innerHTML='';
                s.forEach(c => {
                    if(c.val().status === 'open') {
                        tid = c.key;
                        let m = c.val().messages||{};
                        Object.values(m).forEach(x=>b.innerHTML+=`<div class="msg ${x.sender==='user'?'msg-me':'msg-admin'}">${x.text}</div>`);
                        b.scrollTop = b.scrollHeight;
                    }
                });
            });
        }
        function sendMsg() {
            const v = document.getElementById('chat-input').value; if(!v) return;
            if(!tid) db.ref('support_tickets').push({userId:currentUser.uid, username:userData.username, status:'open', lastMsg:v}).then(r=>{tid=r.key; pm(v);});
            else pm(v);
            document.getElementById('chat-input').value='';
        }
        function pm(t) { db.ref('support_tickets/'+tid+'/messages').push({text:t, sender:'user'}); }

        function nav(p) { document.querySelectorAll('section').forEach(s=>s.classList.add('hidden')); document.getElementById(p+'-page').classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active')); }
        function updateLevel(p) { let l="Ù…Ø¨ØªØ¯Ø¦", w=0; if(p>1000){l="Ù…Ø­ØªØ±Ù"; w=30;} if(p>5000){l="Ø®Ø¨ÙŠØ±"; w=60;} if(p>20000){l="Ø£Ø³Ø·ÙˆØ±Ø©"; w=100;} document.getElementById('lvl-name').innerText=l; document.getElementById('lvl-bar').style.width=w+'%'; }
        function loadLeaderboard() { db.ref('users').orderByChild('points').limitToLast(5).once('value', s=>{ let h=''; let a=[]; s.forEach(c=>a.push(c.val())); a.reverse().forEach((u,i)=>h+=`<div class="leader-item">#${i+1} ${u.username} (${u.points})</div>`); document.getElementById('leader-list').innerHTML=h; }); }
        function convert() { let r = settings.exchangeRate || 1000; if(userData.points < r) return showToast(`ØªØ­ØªØ§Ø¬ ${r}`); db.ref('users/'+currentUser.uid).update({points: userData.points-r, balance: userData.balance+1}); showToast("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„"); }
        function withdraw() { let a = parseFloat(document.getElementById('w-amount').value); if(a > userData.balance) return showToast("Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù"); db.ref('withdrawals').push({userId:currentUser.uid, amount:a, method:document.getElementById('w-method').value, address:document.getElementById('w-addr').value, status:'pending'}); db.ref('users/'+currentUser.uid).update({balance: userData.balance-a}); showToast("ØªÙ… Ø§Ù„Ø·Ù„Ø¨"); }
        function copyRef() { navigator.clipboard.writeText(userData.refCode); showToast("ØªÙ… Ø§Ù„Ù†Ø³Ø®"); }
        function showToast(m) { let t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }
    </script>
</body>
</html>
